<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Geometry Viewer</title>
    <link rel="stylesheet" href="styles.css">
  </head>
    
  <body>

    <div id="app"></div>
    <canvas id="canvas" class="webgl" ></canvas>
    
    <script type="x-shader/x-vertex" id="atmosphereVertex">
      varying vec3 vertexNormal;
      varying vec3 vPositionNormal; 

      void main()
      {
          vertexNormal = normalize(normalMatrix * normal);
          vPositionNormal = normalize(( modelViewMatrix * vec4(position, 1.0) ).xyz);
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1);
      }
  </script>

  <script type="x-shader/x-fragment" id="atmosphereFragment">
      varying vec3 vertexNormal;
      varying vec3 vPositionNormal;
      uniform vec4 uColor; 
      void main()
      {
          float intensity = pow(-0.2 - dot(vertexNormal, vPositionNormal),2.0);     
          gl_FragColor = uColor  * intensity;
      }
  </script>

    <script id="vertexshader" type="vertex">
      varying vec2 vUv;
      void main(){
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    </script>   
    <script id="fragmentshader" type="fragment">
      uniform sampler2D baseTexture;
      uniform sampler2D bloomTexture;
      uniform sampler2D depthTexture;
      
      varying vec2 vUv;
      
      void main() {
          float sceneDepth = texture2D(depthTexture, vUv).r; // Get scene depth
          float bloomDepth = gl_FragCoord.z; // Get current bloom depth
      
          // If bloom is behind another object, fade it out
          if (bloomDepth > sceneDepth + 0.0001) {
              discard;
          }
      
          // Blend bloom normally where depth is valid
          gl_FragColor = (texture2D(baseTexture, vUv) + vec4(1.0) * texture2D(bloomTexture, vUv));
      }
    </script>

    <script type="module" src="/src/Script.ts"></script>
  </body>
</html>